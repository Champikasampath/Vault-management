<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: storage/db.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: storage/db.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Low, JSONFile } from 'lowdb'
import CONSTANTS from "../constants/constants.js";

import { fileURLToPath } from 'url';
import { dirname } from 'path';
const __dirname = dirname(fileURLToPath(import.meta.url));
const dbFile = 'dwellers.json';
const file = __dirname + '/' + dbFile;

const adapter = new JSONFile(file);
const db = new Low(adapter);

export class Db {
	/**
	 * Read From JSON file and store in memory
	 * @return {Promise&lt;void>}
	 */
	async readDb() {
		await db.read();
		if (db &amp;&amp; !db.data) {
			db.data = { dwellers: [] }
		}
	}

	/**
	 * write dweller object to the database
	 * @param data
	 * @param field - property of JSON object
	 */
	async writeSingleDweller(data) {
		await this.readDb()
		db.data.dwellers.push(data);
		await this.commitDb();
	}

	/**
	 * set current year and persist
	 * @param year
	 * @return {Promise&lt;boolean>}
	 */
	async writeCurrentYear(year) {
		await this.readDb();
		if (db.data.current_year &lt; year) {
			console.log(year);
			let updatedDwellers = await this.dieDwellers(year);
			db.data = {dwellers : updatedDwellers, current_year : year}
			await this.commitDb();
			return true;
		} else {
			return false;
		}
	}

	/**
	 * set dead dwellers is_dead status to true :'(
	 * @param currentYear
	 * @return {Promise&lt;void>}
	 */
	async dieDwellers(currentYear) {
		await this.readDb();
		let dwellers = db.data.dwellers;
		dwellers.map(obj =>  {
			if ((currentYear - obj['dob']) >= 70) {
				obj.is_dead = true
			}
		});
		return dwellers;
	}
	/**
	 * persist data
	 * @return {Promise&lt;void>}
	 */
	async commitDb() {
		return await db.write();
	}

	/**
	 * Get Dwellers by ID
	 * @param ic_no
	 * @return {Promise&lt;void>}
	 */
	async getById(ic_no) {
		await this.readDb();
		let dwellers = db.data.dwellers;
		if (typeof dwellers == 'object') {
			return dwellers.find(obj => obj.ic_no == ic_no);
		}
		return false;
	}

	/**
	 * Search object equals to a value
	 * @param field
	 * @param value
	 * @return {Promise&lt;boolean|*>}
	 */
	async searchEqualTo(field, value) {
		await this.readDb();
		let dwellers = db.data.dwellers;
		try {
			return dwellers.filter(obj => obj[field] == value);
		} catch (e) {
			return false
		}
	}

	/**
	 * search for object less than the value
	 * @param field
	 * @param value
	 * @return {Promise&lt;*>}
	 */
	async searchLessThan(field, value) {
		await this.readDb();
		let dwellers = db.data.dwellers;
		try {
			if (field === 'age') {
				if (value > 70) {
					throw new Error(CONSTANTS.MESSAGE.READ.INVALID_AGE)
				}
				let currentYear = db.data.current_year
				return dwellers.filter(obj => (currentYear - obj['dob']) &lt; value);
			}
			return dwellers.filter(obj => obj[field] &lt; value);
		} catch (e) {
			return false;
		}
	}

	/**
	 * search substring
	 * @param field
	 * @param value
	 * @return {Promise&lt;*>}
	 */
	async searchSubstring(field, value) {
		await this.readDb();
		let dwellers = db.data.dwellers;
		try {
			return dwellers.filter(obj => obj[field].includes(value));
		} catch (e) {
			return false;
		}
	}

}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Vault_Vault.html">Vault</a></li></ul><h3>Global</h3><ul><li><a href="global.html#error">error</a></li><li><a href="global.html#info">info</a></li><li><a href="global.html#log">log</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Sat Jul 31 2021 01:47:23 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
